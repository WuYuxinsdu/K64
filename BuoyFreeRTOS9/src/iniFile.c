#include <stdio.h>
#include <string.h>

/*
 * ???:			GetIniKeyString
 * ????:		title
 *						????????????
 *					key
 *						?????????????
 *					filename
 *						????????
 * ???:			??????????????
 *					????NULL
 */
char *GetIniKeyString(char *title,char *key,char *filename)
{
	FILE *fp;
	int  flag = 0;
	char sTitle[32], *wTmp;
	static char sLine[1024];

	sprintf(sTitle, "[%s]", title);
	if(NULL == (fp = fopen(filename, "r"))) {
		perror("fopen");
		return NULL;
	}

	while (NULL != fgets(sLine, 1024, fp)) {
		// ?????
		if (0 == strncmp("//", sLine, 2)) continue;
		if ('#' == sLine[0])              continue;

		wTmp = strchr(sLine, '=');
		if ((NULL != wTmp) && (1 == flag)) {
			if (0 == strncmp(key, sLine, wTmp-sLine)) { // ??????????
				sLine[strlen(sLine) - 1] = '\0';
				fclose(fp);
				return wTmp + 1;
			}
		} else {
			if (0 == strncmp(sTitle, sLine, strlen(sLine) - 1)) { // ??????????
				flag = 1; // ??????
			}
		}
	}
	fclose(fp);
	return NULL;
}

/*
 * ???:			GetIniKeyInt
 * ????:		title
 *						????????????
 *					key
 *						?????????????
 *					filename
 *						????????
 * ???:			??????????????
 *					????NULL
 */
int GetIniKeyInt(char *title,char *key,char *filename)
{
	return atoi(GetIniKeyString(title, key, filename));
}

/*
 * ???:			PutIniKeyString
 * ????:		title
 *						????????????
 *					key
 *						?????????????
 *					val
 *						?????
 *					filename
 *						????????
 * ???:			????  0
 *					???? -1
 */
int PutIniKeyString(char *title,char *key,char *val,char *filename)
{
	FILE *fpr, *fpw;
	int  flag = 0;
	char sLine[1024], sTitle[32], *wTmp;

	sprintf(sTitle, "[%s]", title);
	if (NULL == (fpr = fopen(filename, "r")))
		PRN_ERRMSG_RETURN("fopen");// ?????
	sprintf(sLine, "%s.tmp", filename);
	if (NULL == (fpw = fopen(sLine,    "w")))
		PRN_ERRMSG_RETURN("fopen");// ??????

	while (NULL != fgets(sLine, 1024, fpr)) {
		if (2 != flag) { // ???????????,??????????
			wTmp = strchr(sLine, '=');
			if ((NULL != wTmp) && (1 == flag)) {
				if (0 == strncmp(key, sLine, wTmp-sLine)) { // ??????????
					flag = 2;// ???,??????
					sprintf(wTmp + 1, "%s\n", val);
				}
			} else {
				if (0 == strncmp(sTitle, sLine, strlen(sLine) - 1)) { // ??????????
					flag = 1; // ??????
				}
			}
		}

		fputs(sLine, fpw); // ??????
	}
	fclose(fpr);
	fclose(fpw);

	sprintf(sLine, "%s.tmp", filename);
	return rename(sLine, filename);// ???????????
}

/*
 * ???:			PutIniKeyString
 * ????:		title
 *						????????????
 *					key
 *						?????????????
 *					val
 *						?????
 *					filename
 *						????????
 * ???:			????  0
 *					???? -1
 */
int PutIniKeyInt(char *title,char *key,int val,char *filename)
{
	char sVal[32];
	sprintf(sVal, "%d", val);
	return PutIniKeyString(title, key, sVal, filename);
}



int main(int argc,char *argv[])
{
	printf("%s\n", GetIniKeyString("DOG", "name", "config.ini"));
	printf("%d\n", GetIniKeyInt("DOG", "age", "config.ini"));
	PutIniKeyString("CAT", "name", "ccc", "config.ini");
	PutIniKeyInt("DOG", "age", 56, "config.ini");
	return 0;
}
